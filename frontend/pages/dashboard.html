<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashBordStyle.css">
    <link rel="stylesheet" href="/css/animacaoBack.css">
    <link rel="stylesheet" href="/css/maquinaEscrever.css">
    <link rel="stylesheet" href="/css/transicaoTela.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        span.logo-img {
            height: 280px;
            width: 650px;
            background-image: url('../logo/logoFinal.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: left;
            display: inline-block;
            text-indent: -9999px;
            overflow: hidden;
        }
        .bg-transparente {
            background-color: transparent !important;
        }

        /* Estilização para a data e hora */
        #data-hora-container {
            font-size: 0.9rem;
            color: #fff;
            background-color: rgba(10, 73, 140, 0.7);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            margin-right: 15px; /* Espaço entre a data/hora e os botões */
        }

        #data-hora-container i {
            font-size: 1rem;
        }

        /* Estilização para a contagem regressiva */
        .countdown-cell {
            font-weight: 500;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
        .countdown-past {
            color: #ccc;
            font-style: italic;
        }

        /* ==================================== */
        /* ESTILOS PARA O MODO ESCURO */
        /* ==================================== */
        body.dark-mode {
            background-color: #121212 !important;
            color: #e0e0e0;
        }
        .dark-mode .dashboard-box {
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark-mode #data-hora-container {
            background-color: rgba(50, 50, 50, 0.7);
        }
        .dark-mode .dashboard-box .table tbody tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        .dark-mode .dashboard-box .table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }
        .dark-mode .text-muted {
            color: #a0a0a0 !important;
        }
        .dark-mode .modal-content {
            background-color: #212529;
            color: #e0e0e0;
        }
        .dark-mode .modal-header,
        .dark-mode .modal-footer {
            border-color: #444;
        }
        .dark-mode .modal-title {
            color: #fff;
        }
        .dark-mode .btn-close {
            filter: invert(1);
        }
        .dark-mode .fc-col-header-cell-cushion,
        .dark-mode .fc-daygrid-day-number {
            color: #e0e0e0;
        }
        .dark-mode .fc-theme-standard td,
        .dark-mode .fc-theme-standard th {
            border-color: #333 !important;
        }
        .dark-mode .fc-button-primary {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode .fc-button-primary:hover,
        .dark-mode .fc-button-primary:not(:disabled):active {
            background-color: #555;
            border-color: #777;
        }
        .dark-mode .fc-toolbar-title {
            color: #fff;
        }

        /* Estilização para os botões de ação */
        .btn-acao {
            margin-right: 5px;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.2s ease-in-out;
        }

        .btn-atender {
            margin-right: 10px;
            background-color: #1c4e9e;
            color: #fff;
            transition: all 0.2s ease-in-out;
            border-color: #1c4e9e;
        }
        .btn-atender:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-reagendar {
            margin-right: 10px;
            background-color: #1887af;
            color: #fff;
            border-color: #1887af;
        }
        .btn-reagendar:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-cancelar {
            background-color: #dc3545;
            color: #fff;
            border-color: #dc3545;
        }
        .btn-cancelar:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-acao i {
            margin-right: 8px;
        }
        .nome-paciente {
            cursor: pointer;
            text-decoration: underline;
        }


        /* ==================================== */
        /* ESTILOS GERAIS DA PAGINA E COMPONENTES */
        /* ==================================== */
        .dashboard-box {
            background-color: rgba(10, 73, 140, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .dashboard-box .table thead th {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            background-color: rgba(10, 73, 140, 0.8);
            border: none;
            text-align: center;
        }

        .dashboard-box .table thead {
            display: table-header-group;
        }

        .dashboard-box .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: transparent !important;
        }

        .dashboard-box .table-striped > tbody > tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

        .dashboard-box .table tbody tr {
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            transition: transform 0.2s ease-in-out;
            font-size: larger;
            font-weight: 400;
            border-top: none;
        }

        .dashboard-box .table tbody tr:hover {
            background-color: #add8e6 !important;
            transform: scale(1.02);
            font-weight: bold;
            cursor:pointer;
        }

        .dashboard-box .table tbody tr td {
            border-top: none;
            padding: 1rem;
            text-align: center;
        }

        /* INÍCIO DAS MODIFICAÇÕES DO FULLCALENDAR */
        .fc .fc-toolbar.fc-header-toolbar {
            margin-bottom: 1.5em;
            cursor:pointer;
        }
        .fc-toolbar-title {
            font-size: 1.75em;
            font-weight: 500;
            color: #333;
            cursor:pointer;
        }
        .fc .fc-button-primary {
            background-color: transparent;
            border: 3px solid #ccc;
            color: #555;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }
        .fc .fc-button-primary:hover,
        .fc .fc-button-primary:not(:disabled):active {
            background-color: #f0f0f0;
            border-color: #bbb;
            box-shadow: none;
        }
        .fc-theme-standard th {
            font-weight: 600;
            color: #6c757d;
            background-color: transparent;
            border: none;
        }
        .fc-daygrid-day-frame, .fc-daygrid-day {
            border-radius: 0.5rem;
            border: 1px solid #e9ecef;
        }
        .fc-event {
            border: none;
            font-size: 0.85rem;
            padding: 3px 5px;
            border-radius: 4px;
        }
        .fc-event[style*="background-color: rgb(25, 135, 84);"] {
            background-color: #28a745 !important;
            color: #fff;
        }
        .fc-event[style*="background-color: rgb(160, 196, 255);"] {
            background-color: #a0c4ff !important;
            color: #343a40;
        }
        .fc-event[style*="background-color: rgb(208, 191, 255);"] {
            background-color: #d0bfff !important;
            color: #343a40;
        }

        /* Estilização do botão de voltar ao topo */
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: rgba(10, 73, 140, 0.7);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: scale(0);
        }
        #scrollToTopBtn.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Ajustes para telas menores (responsividade) */
        @media (max-width: 768px) {
            span.logo-img {
                height: 150px;
                width: 350px;
                background-position: center;
            }
            #data-hora-container {
                display: none; /* Esconde a data/hora em telas pequenas para economizar espaço */
            }
        }
    </style>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
</head>

<body>

    <nav class="navbar navbar-expand-lg bg-transparente fade-in-element">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <span class="logo-img" href="dashboard.html">Sistema Terapeuta</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="ms-auto d-flex align-items-center">
                    <div id="data-hora-container">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="data-hora"></span>
                    </div>

                    <a href="pacientes.html" class="btn btn-outline-primary me-2">Pacientes</a>
                    <a href="agendamento.html" class="btn btn-outline-success me-2">Agendar</a>
                    <a href="historico.html" class="btn btn-outline-secondary me-2">Histórico</a>
                    <button id="theme-toggle-btn" class="btn btn-outline-dark ms-2">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5">
        <div class="text-center mb-4 fade-in-element">
            <h1 id="boasVindas" class="fs-2 fw-bold">Bem-vinda!</h1>
            <p class="fs-5">Você está logada no sistema do terapeuta!</p>
        </div>

        <h1 class="text-center fs-5 fade-in-element">Próximos agendamentos:</h1>

        <div class="dashboard-box mt-4 fade-in-element">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle table-borderless">
                    <thead class="table-info">
                        <tr>
                            <th>Paciente</th>
                            <th>Data e Hora</th>
                            <th class="text-center">Contagem Regressiva</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaAgendamentos">
                        <tr>
                            <td colspan="4" class="text-center text-muted">Carregando agendamentos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-box mt-4 fade-in-element">
            <div id="calendar"></div>
        </div>
    </div>

    <div class="modal fade" id="modalReagendamento" tabindex="-1" aria-labelledby="modalReagendamentoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalReagendamentoLabel">Reagendar Atendimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formReagendamento">
                        <input type="hidden" id="reagendarId">
                        <div class="mb-3">
                            <label for="reagendarPaciente" class="form-label">Paciente:</label>
                            <input type="text" class="form-control" id="reagendarPaciente" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="reagendarDataHora" class="form-label">Nova Data e Hora:</label>
                            <input type="datetime-local" class="form-control" id="reagendarDataHora" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Salvar Reagendamento</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAtendimento" tabindex="-1" aria-labelledby="modalAtendimentoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAtendimentoLabel">Seu Primeiro Atendimento do Dia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemAtendimento" class="fs-5"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalLuas" tabindex="-1" aria-labelledby="modalLuasLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLuasLabel">Fases da Lua do Mês</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemLuas" class="fs-5"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ok</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalPaciente" tabindex="-1" aria-labelledby="modalPacienteLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPacienteLabel">Detalhes do Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Informações do Paciente</h5>
                            <p class="card-text">
                                <strong>Nome:</strong> <span id="infoNome"></span>
                            </p>
                            <p class="card-text">
                                <strong>Data de Nascimento:</strong> <span id="infoDataNascimento"></span>
                            </p>
                            <p class="card-text">
                                <strong>Idade:</strong> <span id="infoIdade"></span>
                            </p>
                            <p class="card-text">
                                <strong>Peso:</strong> <span id="infoPeso"></span>
                            </p>
                            <p class="card-text">
                                <strong>Altura:</strong> <span id="infoAltura"></span>
                            </p>
                            <p class="card-text">
                                <strong>Tipo Sanguíneo:</strong> <span id="infoTipoSanguineo"></span>
                            </p>
                            <p class="card-text">
                                <strong>Tipo de Terapia:</strong> <span id="infoTipoTerapia"></span>
                            </p>
                            <p class="card-text">
                                <strong>Data do Agendamento:</strong> <span id="infoDataAgendamento"></span>
                            </p>
                            <p class="card-text">
                                <strong>Motivo da Consulta:</strong> <span id="infoMotivoConsulta"></span>
                            </p>
                            <p class="card-text">
                                <strong>Origem da Indicação:</strong> <span id="infoOrigemIndicacao"></span>
                            </p>
                            <p class="card-text">
                                <strong>Observações:</strong> <span id="infoObservacoes"></span>
                            </p>
                            <p class="card-text">
                                <strong>Condições de Saúde:</strong> <span id="infoCondicoes"></span>
                            </p>
                            <p class="card-text">
                                <strong>Anexo:</strong> <span id="infoAnexo"></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVisualizarAnexo" tabindex="-1" aria-labelledby="modalVisualizarAnexoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" id="dialogVisualizarAnexo">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVisualizarAnexoLabel">Visualizar Anexo</h5>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="maximizeAnexoBtn" title="Maximizar">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body text-center">
                    <div id="anexo-container" style="max-width: 100%; max-height: 80vh;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <button onclick="scrollToTop()" id="scrollToTopBtn" title="Voltar ao topo">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const usuario = localStorage.getItem('usuarioLogado');

        function atualizarDataHora() {
            const now = new Date();
            const dataHora = now.toLocaleString('pt-BR', {
                weekday: 'long', day: '2-digit', month: 'long', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            document.getElementById('data-hora').textContent = dataHora;
        }
        atualizarDataHora();
        setInterval(atualizarDataHora, 1000);

        function escreverTextoComMaquinaEscrever(texto, elementoId) {
            const elemento = document.getElementById(elementoId);
            elemento.textContent = "";
            let i = 0;
            const intervalo = setInterval(() => {
                if (i < texto.length) {
                    elemento.textContent += texto.charAt(i);
                    i++;
                } else {
                    clearInterval(intervalo);
                }
            }, 30);
        }

        if (usuario) {
            const nomeParts = usuario.trim().split(' ');
            const primeiroNome = nomeParts[0].toLowerCase();
            const terminaComA = primeiroNome.endsWith('a');
            const icone = terminaComA ? `<i class="fa-solid fa-user-doctor-female"></i>` : `<i class="fa-solid fa-user-doctor"></i>`;
            const saudacao = terminaComA ? `Bem-vinda, ${usuario} ${icone}` : `Bem-vindo, ${usuario} ${icone}`;
            document.getElementById('boasVindas').innerHTML = saudacao;
        } else {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', async function () {
            await carregarEAtualizarAgendamentos();
            inicializarCalendario();
        });

<<<<<<< HEAD
//  ================ Calendario =========

=======
>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        async function inicializarCalendario() {
            const calendarEl = document.getElementById('calendar');
            let eventosApi = [];

            try {
                const resposta = await fetch('http://localhost:3000/api/agendamentos');
                const agendamentos = await resposta.json();
                eventosApi = agendamentos.map(item => ({
                    title: item.nome + ' - ' + item.tipo_terapia,
                    start: new Date(item.data_agendamento).toISOString(),
                    color: '#28a745'
                }));
            } catch (error) {
                console.error('Erro ao buscar agendamentos para o calendário:', error);
            }

            const luas = [
                { title: '🌕 Lua Cheia', start: '2025-07-21', color: '#a0c4ff' },
                { title: '🌑 Lua Nova', start: '2025-07-06', color: '#d0bfff' },
                { title: '🌕 Lua Cheia', start: '2025-08-19', color: '#a0c4ff' },
                { title: '🌑 Lua Nova', start: '2025-08-04', color: '#d0bfff' }
            ];

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 500,
                locale: 'pt-br',
                themeSystem: 'bootstrap5',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: ''
                },
                events: [...eventosApi, ...luas]
            });
            calendar.render();
        }

        function mostrarModalPrimeiroAtendimento(agendamentosFuturos) {
            const modalAtendimento = new bootstrap.Modal(document.getElementById('modalAtendimento'));
            const mensagemEl = document.getElementById('mensagemAtendimento');

            if (agendamentosFuturos.length > 0) {
                const primeiro = agendamentosFuturos[0];
                const data = new Date(primeiro.data_agendamento);
                const dataFormatada = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                const mensagem = `Seu primeiro atendimento do dia é com o(a) ${primeiro.nome || 'Paciente'} e está confirmado para a data ${dataFormatada} às ${horaFormatada}.`;

                escreverTextoComMaquinaEscrever(mensagem, 'mensagemAtendimento');
                modalAtendimento.show();
            }
        }
<<<<<<< HEAD
//   ====== Mostrar luas ===============
=======
>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5

        function mostrarModalLuas() {
            const modalLuas = new bootstrap.Modal(document.getElementById('modalLuas'));
            const mensagemLuasEl = document.getElementById('mensagemLuas');

            const dataAtual = new Date();
            const mesAtual = dataAtual.getMonth();
            const anoAtual = dataAtual.getFullYear();

            const luasDoMes = [
                { fase: 'Nova', data: new Date(anoAtual, mesAtual, 6) },
                { fase: 'Crescente', data: new Date(anoAtual, mesAtual, 13) },
                { fase: 'Cheia', data: new Date(anoAtual, mesAtual, 21) },
                { fase: 'Minguante', data: new Date(anoAtual, mesAtual, 28) }
            ];

            let mensagem = "As fases da lua para este mês são:\n\n";
            luasDoMes.forEach(lua => {
                mensagem += `Lua ${lua.fase} - ${lua.data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}\n`;
            });

            escreverTextoComMaquinaEscrever(mensagem, 'mensagemLuas');
        }
<<<<<<< HEAD
// ===== Funcao de voltar ao topo ========
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
// ======   ABRIRMODAL DO ANEXO ===============
=======

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        function abrirModalAnexo(filename) {
            const anexoContainer = document.getElementById('anexo-container');
            anexoContainer.innerHTML = '';
            const url = `/uploads/${filename}`;
            const extensao = filename.split('.').pop().toLowerCase();

            if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extensao)) {
                anexoContainer.innerHTML = `<img src="${url}" class="img-fluid" alt="Anexo do Paciente">`;
            } else if (extensao === 'pdf') {
                anexoContainer.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="600px" />`;
            } else {
                anexoContainer.innerHTML = `<p>Tipo de arquivo não suportado para visualização embutida. <a href="${url}" target="_blank">Clique aqui para baixar.</a></p>`;
            }

            const modalVisualizarAnexo = new bootstrap.Modal(document.getElementById('modalVisualizarAnexo'));
            modalVisualizarAnexo.show();
        }
<<<<<<< HEAD
// ====================== modall do paciente ===========================
=======

>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        function abrirModalPaciente(agendamentoJson) {
            try {
                const agendamento = JSON.parse(decodeURIComponent(agendamentoJson));

                const modalPaciente = new bootstrap.Modal(document.getElementById('modalPaciente'));

                document.getElementById('infoNome').textContent = agendamento.nome || 'N/A';
                document.getElementById('infoDataNascimento').textContent = agendamento.data_nascimento ? new Date(agendamento.data_nascimento).toLocaleDateString('pt-BR') : 'N/A';
                document.getElementById('infoIdade').textContent = agendamento.idade || 'N/A';
                document.getElementById('infoPeso').textContent = agendamento.peso ? `${agendamento.peso} kg` : 'N/A';
                document.getElementById('infoAltura').textContent = agendamento.altura ? `${agendamento.altura} cm` : 'N/A';
                document.getElementById('infoTipoSanguineo').textContent = agendamento.tipo_sanguineo || 'N/A';
                document.getElementById('infoTipoTerapia').textContent = agendamento.tipo_terapia || 'N/A';
                document.getElementById('infoMotivoConsulta').textContent = agendamento.motivo_consulta || 'N/A';
                document.getElementById('infoOrigemIndicacao').textContent = agendamento.origem_indicacao || 'N/A';
                document.getElementById('infoObservacoes').textContent = agendamento.observacoes || 'N/A';
                document.getElementById('infoCondicoes').textContent = agendamento.condicoes || 'N/A';

                const infoAnexo = document.getElementById('infoAnexo');
                let anexosHtml = '';

                if (agendamento.anexos && agendamento.anexos.length > 0) {
                    agendamento.anexos.forEach(anexo => {
                        anexosHtml += `<div><a href="#" onclick="abrirModalAnexo('${anexo.caminho_servidor}'); return false;">${anexo.nome_original}</a></div>`;
                    });
                    infoAnexo.innerHTML = anexosHtml;
                } else {
                    infoAnexo.textContent = 'N/A';
                }

                const dataFormatada = new Date(agendamento.data_agendamento).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('infoDataAgendamento').textContent = dataFormatada;

                modalPaciente.show();
            } catch (e) {
                console.error('Erro ao abrir modal do paciente:', e);
            }
        }
<<<<<<< HEAD
//  ========  ATENDER AGENDAMENTO ==========
=======

>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        async function atenderAgendamento(agendamentoJson) {
            try {
                const agendamento = JSON.parse(decodeURIComponent(agendamentoJson));
                sessionStorage.setItem("atendimento", JSON.stringify(agendamento));
                window.location.href = "atendimento.html";
            } catch (error) {
                console.error("Erro ao iniciar atendimento:", error);
                alert("Não foi possível iniciar o atendimento.");
            }
        }

        function abrirModalReagendamento(agendamentoJson) {
            try {
                const agendamento = JSON.parse(decodeURIComponent(agendamentoJson));
                document.getElementById('reagendarId').value = agendamento.id;
                document.getElementById('reagendarPaciente').value = agendamento.nome;
                const modalReagendamento = new bootstrap.Modal(document.getElementById('modalReagendamento'));
                modalReagendamento.show();
            } catch (error) {
                console.error('Erro ao abrir o modal de reagendamento:', error);
            }
        }

        //    =======  Funcao reagendamento ============

document.getElementById('formReagendamento').addEventListener('submit', async function(event) {
    event.preventDefault();
    const id = document.getElementById('reagendarId').value;
    const novaDataHora = document.getElementById('reagendarDataHora').value;

    if (!id || !novaDataHora) {
        console.error('Dados de reagendamento inválidos.');
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/agendamentos/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ data_agendamento: novaDataHora })
        });

        if (response.ok) {
            alert('Agendamento reagendado com sucesso!');
            const modalReagendamento = bootstrap.Modal.getInstance(document.getElementById('modalReagendamento'));
            modalReagendamento.hide();
            // Assumindo que a função para recarregar a tabela se chama carregarEAtualizarAgendamentos
            // Se o nome for diferente, ajuste-o aqui.
            carregarEAtualizarAgendamentos();
        } else {
            const error = await response.json();
            alert('Erro ao reagendar: ' + (error.message || response.statusText));
        }
    } catch (error) {
        console.error('Erro ao reagendar agendamento:', error);
        alert('Erro ao reagendar agendamento. Tente novamente mais tarde.');
    }
});

<<<<<<< HEAD
//  ======== CONTAGEM REGRESSIVA ========

=======
>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        function atualizarContagemRegressiva(agendamentos) {
            const agora = new Date().getTime();
            const linhas = document.querySelectorAll('#tabelaAgendamentos tr');
            linhas.forEach((tr, index) => {
                const agendamento = agendamentos[index];
                if (!agendamento) return;
                const timestamp = new Date(agendamento.data_agendamento).getTime();
                const diferenca = timestamp - agora;
                const cell = tr.querySelector('.countdown-cell');
                if (diferenca > 0) {
                    const dias = Math.floor(diferenca / (1000 * 60 * 60 * 24));
                    const horas = Math.floor((diferenca % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutos = Math.floor((diferenca % (1000 * 60 * 60)) / (1000 * 60));
                    const segundos = Math.floor((diferenca % (1000 * 60)) / 1000);
                    let texto = "";
                    if (dias > 0) texto += `${dias}d `;
                    if (horas > 0) texto += `${horas}h `;
                    if (minutos > 0) texto += `${minutos}m `;
                    texto += `${segundos}s`;
                    cell.textContent = texto;
                    cell.classList.remove('countdown-past');
                } else {
                    cell.textContent = 'Agendamento finalizado';
                    cell.classList.add('countdown-past');
                }
            });
        }
<<<<<<< HEAD
//  ======== CARREGAE ATUALIZA AGENDAMENTOS ========
=======

>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        async function carregarEAtualizarAgendamentos() {
            const tabelaAgendamentos = document.getElementById('tabelaAgendamentos');
            tabelaAgendamentos.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Carregando agendamentos...</td></tr>';
            try {
                const resposta = await fetch('http://localhost:3000/api/agendamentos');
                if (!resposta.ok) throw new Error('Erro ao carregar agendamentos');
                const agendamentos = await resposta.json();
                tabelaAgendamentos.innerHTML = '';
                if (agendamentos.length === 0) {
                    tabelaAgendamentos.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum agendamento futuro encontrado.</td></tr>';
                    return;
                }
                const agendamentosFuturos = agendamentos.filter(agendamento => {
                    const dataAgendamento = new Date(agendamento.data_agendamento);
                    return dataAgendamento > new Date();
                }).sort((a, b) => new Date(a.data_agendamento) - new Date(b.data_agendamento));
                agendamentosFuturos.forEach(agendamento => {
                    const dataAgendamento = new Date(agendamento.data_agendamento);
                    const dataFormatada = dataAgendamento.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + '/' + dataAgendamento.getFullYear() + '<br>' + dataAgendamento.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    const agendamentoString = encodeURIComponent(JSON.stringify(agendamento));

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <span class="nome-paciente" onclick="abrirModalPaciente('${agendamentoString}')">
                                ${agendamento.nome}
                            </span>
                        </td>
                        <td>${dataFormatada}</td>
                        <td class="countdown-cell" data-timestamp="${dataAgendamento.getTime()}"></td>
                        <td>
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-sm btn-atender" title="Atender" onclick="atenderAgendamento('${agendamentoString}')">
                                    <i class="fas fa-play"></i> Atender
                                </button>
                                <button class="btn btn-sm btn-reagendar" title="Reagendar"
                                    onclick="abrirModalReagendamento('${agendamentoString}')">
                                    <i class="fas fa-calendar-alt"></i> Reagendar
                                </button>
                                <button class="btn btn-sm btn-cancelar" title="Cancelar" onclick="cancelarAgendamento(${agendamento.id})">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </td>
                    `;
                    tabelaAgendamentos.appendChild(row);
                });
                setInterval(() => atualizarContagemRegressiva(agendamentosFuturos), 1000);
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                tabelaAgendamentos.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Erro ao carregar agendamentos. Verifique o console para mais detalhes.</td></tr>';
            }
        }
<<<<<<< HEAD
//   ======= CANCELAR AGENDAMENTO ===============
=======

>>>>>>> 3959620b0900f06c3eea4d8f921ebede1266b5c5
        async function cancelarAgendamento(agendamentoId) {
            if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
            try {
                const resposta = await fetch(`http://localhost:3000/api/agendamentos/${agendamentoId}`, { method: 'DELETE' });
                if (resposta.ok) {
                    alert('Agendamento cancelado com sucesso!');
                    carregarEAtualizarAgendamentos();
                } else {
                    const erro = await resposta.json();
                    alert('Erro ao cancelar agendamento: ' + (erro.message || 'Erro desconhecido.'));
                    console.error('Erro de resposta do servidor:', erro);
                }
            } catch (erro) {
                console.error('Erro ao cancelar agendamento:', erro);
                alert('Erro ao cancelar agendamento. Verifique a conexão com o servidor.');
            }
        }
    </script>
</body>
</html>